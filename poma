#!/bin/bash

# Poma é¡¹ç›®ä¸»æ§åˆ¶è„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼š./poma <command>

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    echo "ğŸ§ Poma - æ’­å®¢ä¹¦ç­¾ç¬”è®°å·¥å…·"
    echo ""
    echo "ç”¨æ³•: ./poma <command>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  start-backend    å¯åŠ¨åç«¯æœåŠ¡å™¨"
    echo "  stop-backend     åœæ­¢åç«¯æœåŠ¡å™¨" 
    echo "  build-android    æ„å»º Android åº”ç”¨"
    echo "  dev              å¯åŠ¨å¼€å‘æ¨¡å¼ (åç«¯ + æ–‡æ¡£è¯´æ˜)"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†æ„å»ºæ–‡ä»¶"
    echo "  help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  ./poma start-backend  # å¯åŠ¨åç«¯"
    echo "  ./poma build-android  # æ„å»º Android"
    echo "  ./poma dev           # å¼€å‘æ¨¡å¼"
}

check_backend_status() {
    if curl -s http://localhost:8001/health > /dev/null 2>&1; then
        echo "âœ… åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (http://localhost:8001)"
    else
        echo "âŒ åç«¯æœåŠ¡å™¨æœªè¿è¡Œ"
    fi
}

case "$1" in
    "start-backend"|"backend"|"start")
        echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡å™¨..."
        "$SCRIPT_DIR/scripts/start-backend.sh"
        ;;
    "stop-backend"|"stop")
        echo "ğŸ›‘ åœæ­¢åç«¯æœåŠ¡å™¨..."
        "$SCRIPT_DIR/scripts/stop-backend.sh"
        ;;
    "build-android"|"build"|"android")
        echo "ğŸ“± æ„å»º Android åº”ç”¨..."
        "$SCRIPT_DIR/scripts/build-android.sh"
        ;;
    "dev"|"development")
        echo "ğŸ”§ å¯åŠ¨å¼€å‘æ¨¡å¼..."
        echo "1. å¯åŠ¨åç«¯æœåŠ¡å™¨..."
        "$SCRIPT_DIR/scripts/start-backend.sh" &
        BACKEND_PID=$!
        
        echo "2. ç­‰å¾…åç«¯å¯åŠ¨..."
        sleep 3
        
        echo "3. æ‰“å¼€å¼€å‘æ–‡æ¡£..."
        echo ""
        echo "ğŸ“š å¼€å‘èµ„æº:"
        echo "   - åç«¯ API: http://localhost:8001"
        echo "   - API æ–‡æ¡£: http://localhost:8001/docs" 
        echo "   - å¼€å‘æŒ‡å—: cat DEVELOPMENT.md"
        echo ""
        echo "æŒ‰ Ctrl+C åœæ­¢å¼€å‘æ¨¡å¼"
        
        # ç­‰å¾… Ctrl+C
        trap "echo ''; echo 'åœæ­¢å¼€å‘æ¨¡å¼...'; kill $BACKEND_PID 2>/dev/null; exit" INT
        wait $BACKEND_PID
        ;;
    "status")
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
        check_backend_status
        
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            APK_SIZE=$(ls -lh android/app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')
            echo "âœ… Android APK å·²æ„å»º ($APK_SIZE)"
        else
            echo "âŒ Android APK æœªæ„å»º"
        fi
        ;;
    "clean")
        echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
        rm -rf backend/venv/__pycache__
        rm -rf android/app/build
        rm -rf android/build
        echo "âœ… æ¸…ç†å®Œæˆ"
        ;;
    "help"|"--help"|"-h"|"")
        show_help
        ;;
    *)
        echo "âŒ æœªçŸ¥å‘½ä»¤: $1"
        echo ""
        show_help
        exit 1
        ;;
esac